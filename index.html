<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blackjack — HS Edition</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Profile Hub Button -->
<header>
  <div id="profileBtn" class="profile-btn">
    <div class="avatar" id="playerAvatar">HS</div>
    <div class="profile-info">
      <span id="playerName">Player</span>
      <span id="playerBank">$1000</span>
    </div>
  </div>
</header>

<!-- Game Table -->
<main>
  <!-- Dealer Area -->
  <section id="dealerArea">
    <div class="avatar dealer-avatar">D</div>
    <div id="dealerCards" class="cards"></div>
    <div id="dealerTotal" class="total"></div>
  </section>

  <!-- Player Seats -->
  <section id="seatsArea">
    <div class="seat" data-seat="1">
      <div class="avatar seat-avatar">HS</div>
      <div class="bet" id="bet1">$0</div>
      <div class="cards" id="hand1"></div>
      <div class="total" id="total1"></div>
    </div>
    <div class="seat" data-seat="2">
      <div class="avatar seat-avatar">HS</div>
      <div class="bet" id="bet2">$0</div>
      <div class="cards" id="hand2"></div>
      <div class="total" id="total2"></div>
    </div>
    <div class="seat" data-seat="3">
      <div class="avatar seat-avatar">HS</div>
      <div class="bet" id="bet3">$0</div>
      <div class="cards" id="hand3"></div>
      <div class="total" id="total3"></div>
    </div>
  </section>

  <!-- Seat Toggle -->
  <div id="seatToggle">
    <button data-seats="1" class="active">1 Seat</button>
    <button data-seats="2">2 Seats</button>
    <button data-seats="3">3 Seats</button>
  </div>

  <!-- Chips & Actions -->
  <div id="chipsArea">
    <button class="chip" data-value="5">$5</button>
    <button class="chip" data-value="20">$20</button>
    <button class="chip" data-value="50">$50</button>
    <button class="chip" data-value="100">$100</button>
  </div>
  <div id="actionButtons">
    <button id="dealBtn">Deal</button>
    <button id="hitBtn" disabled>Hit</button>
    <button id="standBtn" disabled>Stand</button>
    <button id="doubleBtn" disabled>Double</button>
    <button id="splitBtn" disabled>Split</button>
  </div>
</main>

<!-- Profile Hub Panel -->
<div id="profilePanel" class="hidden">
  <div class="profile-header">
    <div class="avatar large" id="profileAvatar">HS</div>
    <input type="text" id="nameInput" placeholder="Your name">
  </div>
  <div class="settings-group">
    <label>Table Theme:</label>
    <select id="themeSelect">
      <option value="green">Green</option>
      <option value="midnight">Midnight</option>
      <option value="classic">Classic</option>
    </select>
  </div>
  <div class="settings-group">
    <label>Chip Theme:</label>
    <select id="chipTheme">
      <option value="classic">Classic</option>
      <option value="neon">Neon</option>
      <option value="mono">Monochrome</option>
    </select>
  </div>
  <div class="settings-group">
    <label>Sound:</label>
    <input type="checkbox" id="soundToggle">
  </div>
  <div class="settings-group">
    <label>Rules:</label>
    <select id="ruleSet">
      <option value="crown">Crown Casino</option>
      <option value="vegas">Vegas</option>
    </select>
  </div>
  <div class="settings-group">
    <label>Decks:</label>
    <input type="number" id="deckCount" min="1" max="8" value="6">
  </div>
  <div class="settings-group">
    <button id="resetStats">Reset Stats</button>
    <button id="resetBank">Reset Bank</button>
  </div>
  <button id="closeProfile">Close</button>
</div>

<script src="script.js"></script>
</body>
</html>
/* ====== RESET / BASICS ====== */
* { box-sizing: border-box; }
html, body { margin: 0; height: 100%; }
body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  color: #fff;
  background: #0b132b;  /* midnight default */
}

/* ====== LAYOUT ====== */
header {
  max-width: 1000px;
  margin: 12px auto 0;
  padding: 0 12px;
  display: flex;
  justify-content: flex-end;
}
main {
  max-width: 1000px;
  margin: 0 auto;
  padding: 12px;
}
#dealerArea, #seatsArea, #seatToggle, #chipsArea, #actionButtons {
  margin: 10px 0;
}

/* ====== PROFILE BUTTON ====== */
.profile-btn {
  display: flex; align-items: center; gap: 10px;
  background: #3a506b; padding: 8px 12px; border-radius: 999px;
  cursor: pointer; user-select: none;
}
.profile-info { display: flex; flex-direction: column; line-height: 1; }
.profile-info #playerName { font-weight: 800; }
.profile-info #playerBank { opacity: .9; font-weight: 700; }

/* ====== AVATARS ====== */
.avatar {
  width: 32px; height: 32px; border-radius: 50%;
  display: grid; place-items: center; font-weight: 900;
  background: #38bdf8; color: #001014;
}
.avatar.large { width: 56px; height: 56px; font-size: 18px; }
.dealer-avatar { background: #f59e0b; color:#1a1200; }

/* ====== TABLE / CARDS ====== */
#dealerArea, #seatsArea {
  background: #1c2541;
  border-radius: 16px;
  padding: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
  position: relative;
  overflow: hidden;
}
#dealerArea::before {
  content:""; position:absolute; inset:-20% -10% auto -10%; height:70%;
  background: radial-gradient(ellipse at 50% 120%, #14532d, #0b3d23 60%, transparent 65%);
  opacity: .55; border-radius: 50%/60%;
}

.cards { display:flex; gap:8px; flex-wrap:wrap; align-items:center; min-height:110px; }
.total { font-weight: 800; opacity:.95; margin-top: 4px; }
.seat {
  background: #162238; border-radius:12px; padding:10px; min-width: 240px;
  outline: 2px solid transparent; transition: outline-color .15s, box-shadow .15s;
}
.seat.active { outline-color: #5bc0be; box-shadow: 0 0 18px rgba(91,192,190,.25); }

.bet {
  display:inline-block; background:#0b3344; border:2px dashed #ffffff33;
  padding:6px 10px; border-radius:999px; font-weight:800; margin: 6px 0;
}

/* Single playing card */
.card {
  width:64px; height:94px; border-radius:8px; position:relative;
  background: linear-gradient(145deg, #fff, #f1f1f1); color:#111;
  display:grid; place-items:center; font-weight:800;
  box-shadow:0 2px 8px rgba(0,0,0,.35);
  transform:translateY(20px); opacity:0; animation: pop .22s forwards;
}
@keyframes pop { to { transform: translateY(0); opacity: 1; } }
.card .small { position:absolute; top:6px; left:8px; font-size:12px; }
.card .big { font-size:22px; }
.card .suit { position:absolute; bottom:6px; right:8px; font-size:12px; }
.card.red { color:#c1121f; }
.card.back {
  background: repeating-linear-gradient(45deg, #19376d, #19376d 8px, #0b2447 8px, #0b2447 16px);
  color:#fff;
}

/* ====== SEAT GRID ====== */
#seatsArea {
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 12px;
}
@media (max-width: 780px) {
  #seatsArea { grid-template-columns: 1fr; }
}

/* ====== SEAT TOGGLE ====== */
#seatToggle { display:flex; justify-content:center; gap:10px; }
#seatToggle button {
  padding:8px 12px; border-radius:999px; border:none; font-weight:800;
  background:#0f4c5c; color:#fff; cursor:pointer;
}
#seatToggle button.active { outline:2px solid #5bc0be; background:#126b83; }

/* ====== CHIPS ====== */
#chipsArea { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
.chip {
  width:48px; height:48px; border-radius:50%; border:none; cursor:pointer; font-weight:900;
  position:relative; box-shadow:0 4px 10px rgba(0,0,0,.4); color:#111;
}
.chip::after {
  content:"HS"; position:absolute; inset:10px; border-radius:50%;
  background:#fff; display:grid; place-items:center; font-size:12px; font-weight:900;
}
.chip[data-value="5"]   { background: conic-gradient(#ddd 0 25%, #0b5 0 50%, #ddd 0 75%, #0b5 0); }
.chip[data-value="20"]  { background: conic-gradient(#ddd 0 25%, #0af 0 50%, #ddd 0 75%, #0af 0); }
.chip[data-value="50"]  { background: conic-gradient(#ddd 0 25%, #f59e0b 0 50%, #ddd 0 75%, #f59e0b 0); }
.chip[data-value="100"] { background: conic-gradient(#ddd 0 25%, #8b5cf6 0 50%, #ddd 0 75%, #8b5cf6 0); }

/* Chip themes */
body.chip-classic .chip { filter:none; }
body.chip-neon .chip    { box-shadow: 0 0 10px rgba(91,192,190,.9), 0 0 20px rgba(91,192,190,.5); }
body.chip-mono .chip    { filter: grayscale(100%) contrast(1.15); }

/* ====== ACTION BUTTONS ====== */
#actionButtons { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
#actionButtons button, #dealBtn {
  padding:10px 14px; border-radius:10px; border:none; font-weight:800;
  background:#5bc0be; color:#031926; cursor:pointer;
}
#actionButtons button:disabled { opacity:.5; }

/* ====== PROFILE PANEL (slide-up) ====== */
#profilePanel {
  position: fixed; inset: 0; background: #0e1a2d; color:#fff;
  transform: translateY(100%); transition: transform .25s ease; z-index: 50;
  padding-bottom: 24px;
}
#profilePanel.open { transform: translateY(0); }
.profile-header {
  display:flex; align-items:center; gap:12px; padding: 14px; border-bottom:1px solid #ffffff22;
}
#profilePanel .settings-group {
  display:flex; align-items:center; gap:12px; padding: 12px 14px; border-bottom:1px solid #ffffff0f;
}
#profilePanel input[type="text"], #profilePanel input[type="number"], #profilePanel select {
  flex:1; padding:8px; border:none; border-radius:8px; background:#1a2641; color:#fff;
}
#closeProfile {
  margin: 16px auto 0; display:block; padding:10px 14px; border:none; border-radius:10px; font-weight:800;
  background:#5bc0be; color:#031926; cursor:pointer;
}

/* ====== THEMES ====== */
body.theme-green  { background:#06301e; }
body.theme-green  #dealerArea, body.theme-green #seatsArea { background:#0f4a2b; }
body.theme-midnight { background:#0b132b; }
body.theme-midnight #dealerArea, body.theme-midnight #seatsArea { background:#1c2541; }
body.theme-classic { background:#1d1a24; }
body.theme-classic #dealerArea, body.theme-classic #seatsArea { background:#2a2432; }

/* ====== UTIL ====== */
.hidden { display:none; }
/* =========================
   Blackjack — HS Edition JS
   ========================= */

/* ---------- Shortcuts & Elements ---------- */
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];

const profileBtn = $('#profileBtn');
const profilePanel = $('#profilePanel');
const closeProfileBtn = $('#closeProfile');

const playerNameEl = $('#playerName');
const playerBankEl = $('#playerBank');
const playerAvatarBtn = $('#playerAvatar');
const profileAvatar = $('#profileAvatar');
const nameInput = $('#nameInput');

const themeSelect = $('#themeSelect');
const chipThemeSelect = $('#chipTheme');
const soundToggle = $('#soundToggle');

const ruleSetEl = $('#ruleSet');         // crown / vegas
const deckCountEl = $('#deckCount');

const dealerCardsEl = $('#dealerCards');
const dealerTotalEl = $('#dealerTotal');

const seatToggleBar = $('#seatToggle');
const seatButtons = $$('#seatToggle button');

const seats = [1,2,3].map(i => ({
  root: $(`.seat[data-seat="${i}"]`),
  bet:  $(`#bet${i}`),
  cards: $(`#hand${i}`),
  total: $(`#total${i}`)
}));

const chips = $$('#chipsArea .chip');
const dealBtn   = $('#dealBtn');
const hitBtn    = $('#hitBtn');
const standBtn  = $('#standBtn');
const doubleBtn = $('#doubleBtn');
const splitBtn  = $('#splitBtn');

/* ---------- Persistent State ---------- */
let name   = localStorage.getItem('bj_name') || 'Player';
let ini    = localStorage.getItem('bj_ini')  || initialsFromName(name);
let bank   = parseInt(localStorage.getItem('bj_bank') || '1000', 10);
let theme  = localStorage.getItem('bj_theme') || 'midnight';   // midnight | green | classic
let chipTheme = localStorage.getItem('bj_chipTheme') || 'classic'; // classic | neon | mono
let muted  = localStorage.getItem('bj_muted') === 'true';
let ruleSet = localStorage.getItem('bj_rule') || 'crown';       // crown | vegas
let deckCount = parseInt(localStorage.getItem('bj_decks') || '6', 10);

let activeSeatsCount = 1;     // 1–3 (controlled by seatToggle)
let bets = [0,0,0];           // per-seat bet amounts (index 0..2)
let inRound = false;

/* ---------- Sounds ---------- */
const ctx = new (window.AudioContext || window.webkitAudioContext)();
function beep(f=600,d=.05,t='sine',v=.03){
  if(muted) return;
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.type=t; o.frequency.value=f; g.gain.value=v;
  o.connect(g); g.connect(ctx.destination);
  o.start();
  setTimeout(()=>{ try{o.stop()}catch{} }, d*1000);
}
const s_deal = () => beep(700,.04,'square');
const s_click= () => beep(500,.03,'triangle');
const s_bust = () => beep(250,.25,'sawtooth',.05);
const s_win  = () => { beep(880,.08,'square'); setTimeout(()=>beep(980,.08,'square'),100); };
const s_lose = () => beep(330,.12,'triangle');
const s_push = () => beep(660,.08,'sine');
const s_shuffle=()=> beep(220,.08,'sine');

/* ---------- Shoe / Cards ---------- */
const SUITS = ['♠','♥','♦','♣'];
const RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
let shoe = [], cutIndex = 0;

function newShoe(decks){
  const s=[];
  for(let d=0; d<decks; d++){
    for(const su of SUITS) for(const r of RANKS) s.push({rank:r,suit:su});
  }
  for(let i=s.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [s[i],s[j]]=[s[j],s[i]]; }
  cutIndex = Math.floor(s.length * 0.25);  // reshuffle when 75% used
  s_shuffle();
  return s;
}
function ensureShoe(){
  if (shoe.length===0) shoe = newShoe(deckCount);
  if (shoe.length <= cutIndex) shoe = newShoe(deckCount);
}
function draw(){
  ensureShoe();
  s_deal();
  return shoe.pop();
}

function cardValue(rank){
  if(rank==='A') return 11;
  if(rank==='K'||rank==='Q'||rank==='J') return 10;
  return parseInt(rank,10);
}
function handValue(cards){
  let total=0, aces=0;
  for(const c of cards){ total+=cardValue(c.rank); if(c.rank==='A') aces++; }
  while(total>21 && aces>0){ total-=10; aces--; }
  return total;
}
function isSoft(cards){
  let total=0, aces=0;
  for(const c of cards){ total+=cardValue(c.rank); if(c.rank==='A') aces++; }
  while(total>21 && aces>0){ total-=10; aces--; }
  return aces>0 && total<=21;
}
const isBlackjack = cards => cards.length===2 && handValue(cards)===21;

/* ---------- Round State ---------- */
let dealer = [];
let playerHands = [[],[],[]];     // only first activeSeatsCount used this round
let handBets = [0,0,0];
let doubled  = [false,false,false];
let splitCount=[0,0,0];
let finished = [false,false,false];

let speedMs = 220;               // set in init from themeSelect etc.
let vegasHole = false;           // true only if ruleSet==='vegas'
let hideHole = true;
let awaitingInsurance = false;
let activeHandIndex = 0;

/* ---------- UI Helpers ---------- */
function setBank(v){ bank=v; playerBankEl.textContent = '$'+bank; localStorage.setItem('bj_bank', String(bank)); }
function initialsFromName(n){
  const p = n.trim().split(/\s+/).slice(0,2).map(s=>s[0]||'').join('');
  return (p || 'PL').toUpperCase();
}
function setTheme(t){
  document.body.classList.remove('theme-green','theme-midnight','theme-classic');
  const cls = t==='green'?'theme-green':t==='classic'?'theme-classic':'theme-midnight';
  document.body.classList.add(cls);
}
function setChipTheme(t){
  document.body.classList.remove('chip-classic','chip-neon','chip-mono');
  document.body.classList.add('chip-'+t);
}
function seatActive(i){ return i < activeSeatsCount; }

/* ---------- Render ---------- */
function renderCard(el, card, faceDown=false){
  const d = document.createElement('div');
  if(faceDown){ d.className='card back'; d.textContent='🂠'; el.appendChild(d); return; }
  const red = (card.suit==='♥' || card.suit==='♦') ? ' red':'';
  d.className='card'+red;
  d.innerHTML = `<span class="small">${card.rank}</span><span class="big">${card.rank}</span><span class="suit">${card.suit}</span>`;
  el.appendChild(d);
}

function renderDealer(){
  dealerCardsEl.innerHTML='';
  dealer.forEach((c,i)=>{
    const faceDown = (hideHole && vegasHole && i===1);
    renderCard(dealerCardsEl, c, faceDown);
  });
  const v = handValue(hideHole && vegasHole ? [dealer[0]] : dealer);
  dealerTotalEl.textContent = (dealer.length ? v : '');
}

function renderSeats(){
  seats.forEach((s,idx)=>{
    s.root.classList.toggle('active', idx===activeHandIndex && inRound);
    s.cards.innerHTML='';
    if(!seatActive(idx)) {
      s.bet.textContent = '$0';
      s.total.textContent='';
      return;
    }
    for(const c of playerHands[idx]) renderCard(s.cards, c, false);
    s.bet.textContent = '$'+handBets[idx];
    const v = handValue(playerHands[idx]);
    s.total.textContent = v ? v : '';
  });
}

function renderAll(){
  renderDealer();
  renderSeats();
  // buttons
  const canAct = inRound && !awaitingInsurance;
  hitBtn.disabled = !canAct;
  standBtn.disabled = !canAct;
  doubleBtn.disabled = !canAct || playerHands[activeHandIndex].length!==2 || bank < handBets[activeHandIndex];
  const h = playerHands[activeHandIndex];
  const canSplit = canAct && h.length===2 && h[0]?.rank===h[1]?.rank && (h[0].rank!=='A' || splitCount[activeHandIndex]<2);
  splitBtn.disabled = !canSplit;
}

/* ---------- Hints (lightweight) ---------- */
function upcardVal(){ return dealer[0] ? cardValue(dealer[0].rank) : 0; }
function hintFor(hand){
  const v = handValue(hand), up = upcardVal(), soft = isSoft(hand);
  let move='Stand';
  const pair = (hand.length===2 && hand[0].rank===hand[1].rank);
  if(pair){
    const r = hand[0].rank;
    if(r==='A'||r==='8') move='Split';
    else if(r==='9') move=(up===7||up>=10)?'Stand':'Split';
    else if(r==='7') move=up<=7?'Split':'Hit';
    else if(r==='6') move=up<=6?'Split':'Hit';
    else if(r==='4') move=(up===5||up===6)?'Split':'Hit';
    else if(r==='2'||r==='3') move=up<=7?'Split':'Hit';
  }else if(soft){
    if(v<=17) move=up<=6?'Double':'Hit';
    else if(v===18) move=(up<=6?'Double':(up>=9?'Hit':'Stand'));
    else move='Stand';
  }else{
    if(v<=8) move='Hit';
    else if(v===9) move=(up>=3&&up<=6)?'Double':'Hit';
    else if(v===10) move=(up<=9)?'Double':'Hit';
    else if(v===11) move='Double';
    else if(v===12) move=(up>=4&&up<=6)?'Stand':'Hit';
    else if(v>=13 && v<=16) move=(up<=6)?'Stand':'Hit';
    else move='Stand';
  }
  return move;
}

/* ---------- Seat Toggle / Bets ---------- */
seatButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(inRound) return;
    seatButtons.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    activeSeatsCount = parseInt(btn.dataset.seats,10);
    // Zero bets for inactive seats visually (we still keep array)
    seats.forEach((s,i)=>{ if(i>=activeSeatsCount) s.bet.textContent='$0'; });
    s_click();
  });
});

chips.forEach(ch=>{
  ch.addEventListener('click', ()=>{
    if(inRound) return;
    const val = parseInt(ch.dataset.value,10);
    // Add to each active seat in order as you tap the seat boxes (simplest: add to first active seat)
    // Better UX: add to the lowest bet active seat to balance 4x20, etc.
    let idx = 0;
    let minBet = Infinity;
    for(let i=0;i<activeSeatsCount;i++){
      if(bets[i] < minBet){ minBet=bets[i]; idx=i; }
    }
    bets[idx] += val;
    seats[idx].bet.textContent = '$'+bets[idx];
    s_click();
  });
});

// Tap the bet pill to undo last chip greedily (100 > 50 > 20 > 5)
seats.forEach((s,idx)=>{
  s.bet.parentElement.addEventListener('click', ()=>{
    if(inRound || idx>=activeSeatsCount) return;
    const order=[100,50,20,5];
    for(const c of order){
      if(bets[idx]-c>=0){
        bets[idx]-=c; seats[idx].bet.textContent='$'+bets[idx]; s_click(); break;
      }
    }
  });
});

/* ---------- Profile Panel ---------- */
function openProfile(){ profilePanel.classList.add('open'); }
function closeProfile(){ profilePanel.classList.remove('open'); }
profileBtn.addEventListener('click', openProfile);
closeProfileBtn.addEventListener('click', closeProfile);

// Name & initials
nameInput.value = name;
playerNameEl.textContent = name;
playerAvatarBtn.textContent = ini;
profileAvatar.textContent = ini;
nameInput.addEventListener('input', ()=>{
  name = nameInput.value.trim() || 'Player';
  playerNameEl.textContent = name;
  const newIni = initialsFromName(name);
  if(ini.length<=2) { // only auto-change initials if using initials (not custom)
    ini = newIni; playerAvatarBtn.textContent=ini; profileAvatar.textContent=ini;
    localStorage.setItem('bj_ini', ini);
  }
  localStorage.setItem('bj_name', name);
  renderAll();
});

// Themes
function applyThemeUI(){
  document.body.classList.remove('theme-midnight','theme-green','theme-classic');
  const cls = theme==='green'?'theme-green':(theme==='classic'?'theme-classic':'theme-midnight');
  document.body.classList.add(cls);
}
themeSelect.value = theme;
applyThemeUI();
themeSelect.addEventListener('change', ()=>{
  theme = themeSelect.value;
  localStorage.setItem('bj_theme', theme);
  applyThemeUI();
});

// Chip themes
chipThemeSelect.value = chipTheme;
setChipTheme(chipTheme);
chipThemeSelect.addEventListener('change', ()=>{
  chipTheme = chipThemeSelect.value;
  localStorage.setItem('bj_chipTheme', chipTheme);
  setChipTheme(chipTheme);
});

// Sound
soundToggle.checked = !muted;
soundToggle.addEventListener('change', ()=>{
  muted = !soundToggle.checked;
  localStorage.setItem('bj_muted', String(muted));
});

// Rules + decks
ruleSetEl.value = ruleSet;
deckCountEl.value = deckCount;
ruleSetEl.addEventListener('change', ()=>{
  ruleSet = ruleSetEl.value; localStorage.setItem('bj_rule', ruleSet);
});
deckCountEl.addEventListener('change', ()=>{
  deckCount = Math.max(1, Math.min(8, parseInt(deckCountEl.value||'6',10)));
  localStorage.setItem('bj_decks', String(deckCount));
  shoe = []; // rebuild next draw
});

/* ---------- Dealing Flow ---------- */
let speed = 220; // will remain simple (you can add speed selector later)
function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }

function resetRoundState(){
  dealer = [];
  playerHands = [[],[],[]];
  handBets = [0,0,0];
  doubled  = [false,false,false];
  splitCount=[0,0,0];
  finished = [false,false,false];
  hideHole = true;
  awaitingInsurance = false;
  activeHandIndex = 0;
}

function validateBets(){
  let total=0;
  for(let i=0;i<activeSeatsCount;i++){ handBets[i] = bets[i]||0; total += handBets[i]; }
  if(total<=0){ toast("Add chips to your seats first."); return false; }
  if(total>bank){ toast("Total bet exceeds bank."); return false; }
  return true;
}

function toast(msg){ dealerTotalEl.textContent = msg; setTimeout(()=>{ dealerTotalEl.textContent=''; }, 1500); }

async function startRound(){
  if(inRound) return;
  if(!validateBets()) return;

  // Lock in bets and deduct
  let total=0; for(let i=0;i<activeSeatsCount;i++) total+=handBets[i];
  setBank(bank - total);

  inRound = true;
  vegasHole = (ruleSet === 'vegas');

  resetRoundState();
  // First pass to each active seat
  for(let i=0;i<activeSeatsCount;i++){
    const c = draw(); playerHands[i].push(c); renderAll(); await sleep(speed);
  }
  // Dealer upcard
  dealer.push(draw()); renderAll(); await sleep(speed);

  // Second pass to each seat
  for(let i=0;i<activeSeatsCount;i++){
    const c = draw(); playerHands[i].push(c); renderAll(); await sleep(speed);
  }
  // Dealer hole card (only Vegas)
  if(vegasHole){ dealer.push(draw()); renderAll(); await sleep(speed); }

  // Insurance offer if Vegas and dealer shows Ace
  if(vegasHole && dealer[0] && dealer[0].rank==='A'){
    awaitingInsurance = true;
    toast("Insurance? (Not implemented here — tap Deal to skip)");
    awaitingInsurance = false; // keeping UI simple for now
  }

  // Instant pay naturals
  if(resolveNaturals()) return;

  // Player move on seat 1
  activeHandIndex = 0;
  flowStatus();
  renderAll();
}

function resolveNaturals(){
  let any=false;
  for(let i=0;i<activeSeatsCount;i++){
    if(isBlackjack(playerHands[i]) && !finished[i]){
      // 3:2 payout right away (return bet + 1.5x)
      setBank(bank + Math.floor(handBets[i] * 2.5));
      finished[i] = true; any=true; s_win();
    }
  }
  renderAll();
  // if all finished (all naturals), end immediately
  if(any && finished.slice(0,activeSeatsCount).every(x=>x)){
    inRound=false; toast("Blackjack! Paid 3:2.");
    return true;
  }
  return false;
}

function flowStatus(){
  // Optional: you can display per-hand hint here using hintFor(playerHands[activeHandIndex])
  const h = hintFor(playerHands[activeHandIndex]);
  dealerTotalEl.textContent = `Hint: ${h}`;
}

/* ---------- Actions ---------- */
dealBtn.addEventListener('click', startRound);

hitBtn.addEventListener('click', ()=>{
  if(!inRound || awaitingInsurance) return;
  const h = playerHands[activeHandIndex];
  h.push(draw());
  renderAll();
  const v = handValue(h);
  if(v>21){ s_bust(); finished[activeHandIndex]=true; nextOrDealer(); }
  else flowStatus();
});

standBtn.addEventListener('click', ()=>{
  if(!inRound || awaitingInsurance) return;
  finished[activeHandIndex]=true;
  nextOrDealer();
});

doubleBtn.addEventListener('click', ()=>{
  if(!inRound || awaitingInsurance) return;
  const i = activeHandIndex, h = playerHands[i];
  if(h.length!==2) { toast('Double only on first move.'); return; }
  if(bank < handBets[i]) { toast('Not enough bank to double.'); return; }
  setBank(bank - handBets[i]);
  doubled[i]=true;
  h.push(draw());
  renderAll();
  finished[i]=true;
  nextOrDealer();
});

splitBtn.addEventListener('click', ()=>{
  if(!inRound || awaitingInsurance) return;
  const i=activeHandIndex, h=playerHands[i];
  if(!(h.length===2 && h[0].rank===h[1].rank)){ toast('Split only on identical ranks.'); return; }
  if(h[0].rank==='A' && splitCount[i] >= 2){ toast('Reached Aces resplit limit.'); return; }
  if(bank < handBets[i]) { toast('Not enough bank to split.'); return; }

  // Deduct another bet
  setBank(bank - handBets[i]);

  // Create new hand after current
  const second = h.pop(), first = [h.pop()];
  playerHands[i] = first;
  playerHands.splice(i+1,0,[second]);
  handBets.splice(i+1,0,handBets[i]);
  doubled.splice(i+1,0,false);
  splitCount[i] = (splitCount[i]||0)+1;
  splitCount.splice(i+1,0, splitCount[i]);
  finished.splice(i+1,0,false);

  // Deal one card to each split
  playerHands[i].push(draw());
  playerHands[i+1].push(draw());
  renderAll();
  flowStatus();
});

function nextOrDealer(){
  // move to next unfinished hand, else dealer play
  for(let i=activeHandIndex+1;i<activeSeatsCount;i++){
    if(!finished[i]) { activeHandIndex=i; renderAll(); flowStatus(); return; }
  }
  dealerPlayAndSettle();
}

function dealerPlayAndSettle(){
  // Reveal hole if hidden
  hideHole = false; renderAll();

  // Only hit on H17 if ruleSet says so (Crown is S17 default)
  const hitSoft17 = (ruleSet === 'vegas'); // you can wire this to a toggle later
  for(;;){
    const v = handValue(dealer);
    const soft = isSoft(dealer);
    if(v<17){ dealer.push(draw()); renderAll(); continue; }
    if(v===17 && soft && hitSoft17){ dealer.push(draw()); renderAll(); continue; }
    break;
  }

  // settle
  const d = handValue(dealer);
  for(let i=0;i<activeSeatsCount;i++){
    const p = handValue(playerHands[i]);
    if(p>21) { s_lose(); continue; }
    if(isBlackjack(playerHands[i])) continue; // already paid
    if(d>21){ // dealer busts
      setBank(bank + (doubled[i]? handBets[i]*4 : handBets[i]*2)); s_win(); continue;
    }
    if(p>d){ setBank(bank + (doubled[i]? handBets[i]*4 : handBets[i]*2)); s_win(); }
    else if(p===d){ setBank(bank + (doubled[i]? handBets[i]*2 : handBets[i])); s_push(); }
    else { s_lose(); }
  }

  inRound=false;
  toast('Round over.');
}

/* ---------- Init ---------- */
function boot(){
  // UI boot
  playerNameEl.textContent = name;
  playerAvatarBtn.textContent = ini;
  profileAvatar.textContent = ini;
  playerBankEl.textContent = '$'+bank;

  // Themes
  document.body.classList.add('theme-midnight'); // default
  setTheme(themeSelect.value = theme);
  setChipTheme(chipThemeSelect.value = chipTheme);

  // SW register (optional but nice)
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js',{scope:'./'}).catch(()=>{}));
  }

  renderAll();
}
boot();
